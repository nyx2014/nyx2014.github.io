
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>idea: Custom File System | Nyx&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="LSR">
    
    <meta name="description" content="此为大坑。

This idea under GPL License.

Flex Storage File System：将存储空间按优劣分级，内存、SSD、HDD，甚至网盘、闪存。按传输速率和存储特性。总之就是可以智能管理你的一切存储空间。
内容有标记为“当需要空间时首先被释放”的标签，还有“需">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Nyx&#39;s Blog" title="Nyx&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Nyx&#39;s Blog">Nyx&#39;s Blog</a></h1>
				<h2 class="blog-motto">人生没有运动和读书解决不了的问题</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">主页|Home</a></li>
					
						<li><a href="/archives">归档|Archives</a></li>
					
						<li><a href="/tags">标签|Tags</a></li>
					
						<li><a href="/categories">分类|Categories</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:nyx2014.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/26/idea-Custom-File-System/" title="idea: Custom File System" itemprop="url">idea: Custom File System</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://nyx2014.github.io" title="LSR">LSR</a>
    </p>
  <p class="article-time">
    <time datetime="2015-08-26T14:43:31.000Z" itemprop="datePublished">2015-08-26</time>
    更新日期:<time datetime="2015-09-02T07:28:34.000Z" itemprop="dateModified">2015-09-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-29更"><span class="toc-number">1.</span> <span class="toc-text">8.29更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-30更"><span class="toc-number">2.</span> <span class="toc-text">8.30更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1更"><span class="toc-number">3.</span> <span class="toc-text">9.1更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2更"><span class="toc-number">4.</span> <span class="toc-text">9.2更</span></a></li></ol>
		</div>
		
		<p>此为大坑。</p>
<blockquote>
<p>This idea under GPL License.</p>
</blockquote>
<p><code>Flex Storage File System</code>：将存储空间按优劣分级，<br>内存、SSD、HDD，甚至网盘、闪存。按传输速率和存储特性。<br>总之就是可以智能管理你的一切存储空间。</p>
<p>内容有标记为“当需要空间时首先被释放”的标签，还有“需要为性能优化的数据”，还有“归档性数据”，还有“需要连续存储的数据”，<br>并为各种专一数据类型建立索引，自动命名（智能命名），树状、图状索引查看，程序和数据可耦合共用。跨驱动器、文件系统级别的存储。</p>
<p>结合网盘、NAS，做自动的高可用性、备份和同步</p>
<p>比如划分了50G空间，剩余30G空闲，<br>那么会根据空闲空间的性质，并在用户标记网络为闲置并未在按流量计费的网络连接中时自动填充缓冲预取内容，<br>不容一点浪费，并在需要请求内容时首先访问此加速区。</p>
<p>查资料的时候，一开始我往windows驱动的方面查去了，<br>还有DDK的东西，<br>《windows 7 设备驱动程序开发》这种专业级别的。。。</p>
<p>还费了很多劲，在CSDN上下了个“虚拟磁盘源码.7z”。。。</p>
<p>嗯，有个叫<code>subst</code>的小东东不错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$subst</span> /?</span><br><span class="line">将路径与驱动器号关联。</span><br><span class="line"></span><br><span class="line">SUBST [drive1: [drive2:]path]</span><br><span class="line">SUBST drive1: /D</span><br><span class="line"></span><br><span class="line">  drive1:        指定要分配路径的虚拟驱动器。</span><br><span class="line">  [drive2:]path  指定物理驱动器和要分配给虚拟驱动器的路径。</span><br><span class="line">  /D             删除被替换的</span><br><span class="line">(虚拟)驱动器。</span><br><span class="line"></span><br><span class="line">不带参数键入 SUBST，以显示当前虚拟驱动器的列表。</span><br></pre></td></tr></table></figure></p>
<p>不过这个玩意。。。嗯。。。</p>
<p>后来又看到了VFS，Linux下的虚拟文件系统，但是可惜，这货是linux的。。。</p>
<p>最后找到了它：<code>Dokan</code>，windows下用户态的文件系统驱动库，太开心了</p>
<p><a href="https://dokan-dev.github.io/" target="_blank" rel="external">https://dokan-dev.github.io/</a></p>
<blockquote>
<p>User Mode File System</p>
<p>Dokan is an user mode file system for Windows.<br>It allows anyone to develop safely and easily a new file system on Windows operating systems. </p>
</blockquote>
<p>我们来看一下Dokan官网上的介绍：</p>
<blockquote>
<p>What is Dokan</p>
<p>When you want to create a new file system on Windows, other than FAT or NTFS, you need to develop a file system driver. Developing a device driver that works in kernel mode on windows is extremely technical. By using Dokan, you can create your own file systems very easily without writing device drivers. Dokan is similar to FUSE (Linux file system in user space) but works on Windows.</p>
</blockquote>
<p>也就是说，这货是仿<code>FUSE</code>的，看人家Linux那一套眼馋，搬过来了。<br>当你想发明一个伟大的文件系统的时候，又不想麻烦写难度五颗星的内核态驱动（<code>kernel mode</code>）<br>那么就用Dokan库吧！<br>excited！</p>
<h3 id="8-29更">8.29更</h3><p>泪奔。。</p>
<p>在网上看到这个东东：<code>Windows Shell Namespace Extension</code>，一开始还没当回事，<br>不过仔细看完介绍之后，我开始动摇了</p>
<blockquote>
<p>Windows Shell namespace（Windows Shell 命名空间）是被 Windows资源管理器 所使用的，<br>向用户呈现文件系统和其他对象的组织系统。<br>在 Windows Shell 命名空间内的对象可以是真正的文件和文件夹,也可以是虚拟的对象，类似于网上邻居和回收站都是“虚拟文件夹”.</p>
</blockquote>
<p>其实对于这样的文件系统驱动，网上有很多实现方案的，在Dokan的介绍里面就说，Dokan不是万能的，如果你想要balabala，<br>那么你可以参考这些方案balabala。<br>对，其中就有这个Windows Shell Namespace Extension，翻译过来就是windows界面里的插件，<br>可以直接给右键菜单添菜，甚至直接在窗口里划一块View出来。。<br>是不是够diao！</p>
<p>我想的很多功能，不仅仅是一个文件系统驱动就可以搞定的，它一定需要上层应用的配合，<br>再说还考虑到一个标准配置界面是不可或缺的，那么就更导致光凭一个<code>WUDF</code>是无法完全实现的</p>
<p>这可咋整！是不是要结合这个WSNE来做呢？它和Dokan又是什么关系，能不能协同工作呢？<br>嗯，不过他俩倒是都在.NET下面，都用C#搞定</p>
<p>欲知后事如何，且等我更新。。</p>
<h3 id="8-30更">8.30更</h3><p>哎，醉了，今天搞代码把机子蓝屏了<br>提醒大家，玩驱动的时候，有条件的一定要在虚机里面走，<br>不然怎么死的都不知道<br>幸亏我的IE开了自动恢复，几十个标签页又回来了(●’◡’●)</p>
<p>找了一个WSNE的demo，居然是个C#和C++的混合体，<br>有个地方是EventHandler响应UI触发事件的，然而那个关键的Handle在哪里啊。。<br>死活没找到，输了输了</p>
<p>在Explorer里修修改改应该是可以的，<br>但是我想到一个小问题就是如何只在我特定的<code>FlexStorage</code>卷上面来自定义ContextMenu呢</p>
<p>我又想到，记得QQ电脑管家可以提供一个功能就是插上U盘的时候在资源管理器里面显示一个侧边栏，很方便的样子<br>嗯，我至少也要做到它那个样子吧？</p>
<p>Dokan的那个Demo居然有bug，Debug模式下会崩，居然用了Release才过的，很神奇，<br>也不明白是为什么</p>
<p>我还闲着试着给废柴FlexStorage加GUI，<br>用WPF，做都做好了，结果呵呵哒了，<br>真是不知道为什么。而且崩的地方是vhost，我还没法调试</p>
<p>好吧，暂时默默去学C#文件操作了。。</p>
<p>让我修炼一百年再战</p>
<h3 id="9-1更">9.1更</h3><p>文件系统可以合并显示可用驱动器的内容了，<br>也可以进入每个文件夹看<br>但是还不能打开文件进行各种操作<br>但现在最麻烦的是，我是不是需要自己维护一个表，来索引各种文件呢？<br>不然的话，我每次进入一个目录，都需要去每个驱动器里面寻找一遍。。</p>
<p>还有一个问题，我这个FusionStorage是建立在已经可用的NTFS卷基础之上的，<br>如果我想只留下我这个文件系统，同时把C盘D盘啊这些给隐藏掉（做成黑箱），<br>该怎么办呢。</p>
<p>毕竟我这个还没有做到直接去访问磁盘上的内容，只是在借助现有的接口而已，<br>感觉好弱智。</p>
<h3 id="9-2更">9.2更</h3><p>昨天生病了ToT…</p>
<p>有个小小的发现，在Windows的磁盘管理中，可以将一个NTFS卷<br><code>装入以下空白NTFS文件夹中</code><br>也就是说，相当于一个链接，直接把卷给mount到一个文件夹里去了。。<br>而且这个功能是和现有的盘符访问不冲突的</p>
<p>再结合组策略编辑器里的<br>用户配置—管理模板—windows组件—windows资源管理器—“隐藏‘我的电脑’中指定的这些驱动器”<br>这个功能</p>
<p>最终的效果是，我把C盘和D盘隐藏了起来，并且新建了一个512M的小分区，把C盘和D盘给挂载进去了<br>此时是完全不影响正常使用的，C盘和D盘仍然可以正常访问。</p>
<p>啊哈哈，然而并没有什么用。</p>
<p>是否可以结合这个功能来开发我的文件系统呢？<br>比如，把不想让用户看到的卷隐藏掉。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/File-System/">File System</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/创意/">创意</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://nyx2014.github.io/2015/08/26/idea-Custom-File-System/" data-title="idea: Custom File System | Nyx&#39;s Blog" data-tsina="undefined" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/26/tutorial-Build-YOUR-Blog/" title="Tutorial: Build YOUR own Blog | 搭建一个属于自己的博客">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Tutorial: Build YOUR own Blog | 搭建一个属于自己的博客</span>
</a>
</div>


<div class="next">
<a href="/2015/08/26/Git迁移/"  title="Git使用技巧：repositories的迁移">
 <strong>NEXT:</strong><br/> 
 <span>Git使用技巧：repositories的迁移
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-29更"><span class="toc-number">1.</span> <span class="toc-text">8.29更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-30更"><span class="toc-number">2.</span> <span class="toc-text">8.30更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1更"><span class="toc-number">3.</span> <span class="toc-text">9.1更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2更"><span class="toc-number">4.</span> <span class="toc-text">9.2更</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/创意/" title="创意">创意<sup>1</sup></a></li>
		
			<li><a href="/categories/技巧/" title="技巧">技巧<sup>2</sup></a></li>
		
			<li><a href="/categories/教程/" title="教程">教程<sup>1</sup></a></li>
		
			<li><a href="/categories/转载/" title="转载">转载<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Apache/" title="Apache">Apache<sup>1</sup></a></li>
		
			<li><a href="/tags/BSD/" title="BSD">BSD<sup>1</sup></a></li>
		
			<li><a href="/tags/Blog/" title="Blog">Blog<sup>1</sup></a></li>
		
			<li><a href="/tags/File-System/" title="File System">File System<sup>1</sup></a></li>
		
			<li><a href="/tags/GPL/" title="GPL">GPL<sup>1</sup></a></li>
		
			<li><a href="/tags/Git/" title="Git">Git<sup>1</sup></a></li>
		
			<li><a href="/tags/Github/" title="Github">Github<sup>1</sup></a></li>
		
			<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/LGPL/" title="LGPL">LGPL<sup>1</sup></a></li>
		
			<li><a href="/tags/Licence/" title="Licence">Licence<sup>1</sup></a></li>
		
			<li><a href="/tags/MIT/" title="MIT">MIT<sup>1</sup></a></li>
		
			<li><a href="/tags/Markdown/" title="Markdown">Markdown<sup>1</sup></a></li>
		
			<li><a href="/tags/OpenSource/" title="OpenSource">OpenSource<sup>1</sup></a></li>
		
			<li><a href="/tags/emmet/" title="emmet">emmet<sup>1</sup></a></li>
		
			<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
		
			<li><a href="/tags/前端开发/" title="前端开发">前端开发<sup>1</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">4</span></li></ul>
  </div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/Apache/" style="font-size: NaNpx;">Apache</a><a href="/tags/BSD/" style="font-size: NaNpx;">BSD</a><a href="/tags/Blog/" style="font-size: NaNpx;">Blog</a><a href="/tags/File-System/" style="font-size: NaNpx;">File System</a><a href="/tags/GPL/" style="font-size: NaNpx;">GPL</a><a href="/tags/Git/" style="font-size: NaNpx;">Git</a><a href="/tags/Github/" style="font-size: NaNpx;">Github</a><a href="/tags/Hexo/" style="font-size: NaNpx;">Hexo</a><a href="/tags/LGPL/" style="font-size: NaNpx;">LGPL</a><a href="/tags/Licence/" style="font-size: NaNpx;">Licence</a><a href="/tags/MIT/" style="font-size: NaNpx;">MIT</a><a href="/tags/Markdown/" style="font-size: NaNpx;">Markdown</a><a href="/tags/OpenSource/" style="font-size: NaNpx;">OpenSource</a><a href="/tags/emmet/" style="font-size: NaNpx;">emmet</a><a href="/tags/git/" style="font-size: NaNpx;">git</a><a href="/tags/前端开发/" style="font-size: NaNpx;">前端开发</a>
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="https://idiotwu.me/" target="_blank" title="idiotWu">Dolphin Wood's Blog</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hi ,I&#39;m Li Sirui form BUCT. <br/>
			This is my blog, welcome everyone.</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="https://github.com/nyx2014" target="_blank" title="github"></a>
		
		<a href="http://stackoverflow.com/users/5151091/nyx2013" target="_blank" title="stackoverflow"></a>
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="https://nyx2014.github.io" target="_blank" title="LSR">LSR</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title')
  var html = [
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  ].join('');
  $this.append(html);
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"nyx2014"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
